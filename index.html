<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Event Check-in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    
    #<script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        Ubuntu: ['Ubuntu', 'sans-serif'], 
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Essential base styles to cover the viewport */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; 
            font-family: 'Ubuntu', sans-serif;
            background-image: url("https://cmu-imc.med.cmu.ac.th/web/wp-content/uploads/2025/10/checkin_wallpaper.png");
        }
        
        #screen-container {
            /* Full viewport cover, centered */
            width: 100vw;
            height: 85vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; /* Added relative positioning to anchor the absolute header controls */
        }
        
        /* Custom glow effects for text based on the image's aesthetic */
        .glowing-text {
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.7), 0 0 8px rgba(255, 255, 255, 0.3);
        }
        .glowing-number {
            text-shadow: 0 0 10px rgba(255, 255, 255, 1), 0 0 25px rgba(255, 255, 255, 0.8);
        }

        /* Visible NFC input styling */
        .nfc-input-hidden {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.375rem;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .nfc-input-hidden:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* Status Styles for visual feedback */
        #statusContainer {
            transition: all 0.3s ease;
            padding: 0.75rem 1rem;
            border: 1px solid transparent;
            min-height: 4rem; /* Ensure minimum space */
        }
        #statusContainer.processing {
            border-color: #3b82f6; /* blue-500 */
            background-color: rgba(59, 130, 246, 0.2);
        }
        #statusContainer.success {
            border-color: #34d399; /* emerald-400 */
            background-color: rgba(52, 211, 153, 0.2);
        }
        #statusContainer.error {
            border-color: #ef4444; /* red-500 */
            background-color: rgba(239, 68, 68, 0.2);
        }
    </style>
</head>
<body>

<div id="screen-container">
    <div class="p-6 md:p-8 flex flex-col justify-between text-white w-full h-full">
        
        <header class="text-center space-y-3 pt-4">
            <div class="flex items-center justify-center w-full">
                <img src="https://cmu-imc.med.cmu.ac.th/web/wp-content/uploads/2025/10/IMC_logo_full_white_color.png" class="h-40 md:h-48">
            </div>

            <div class="text-2xl md:text-4xl font-light glowing-text flex flex-col space-y-1">
                <span id="current-date" class="text-lg md:text-2xl">--</span>
                <span id="current-time">--:--:--</span>
            </div>

            <div id="controls-container" class="absolute top-4 right-4 flex flex-col items-end space-y-2">
                
                <div class="glowing-text w-48">
                    <input id="nfcInput" 
                           type="text" 
                           autofocus 
                           placeholder="Scan NFC tag..." 
                           class="nfc-input-hidden" 
                           aria-label="NFC input"
                    />
                </div>
                
                <div class="glowing-text">
                    <select id="userIdInput" class="nfc-input-hidden">
                        <option value="" disabled selected>Select Terminal</option>
                        <option value="Test1">Test1</option>
                        <option value="Test2">Test2</option>
                        <option value="Test3">Test3</option>
                        <option value="Test4">Test4</option>
                    </select>
                </div>
                
                <div class="flex flex-col items-end">
                    <div class="text-xs uppercase tracking-wider opacity-90 glowing-text">Total Scanned</div>
                    <div class="text-2xl uppercase tracking-wider opacity-90 glowing-text" id="scanned-count">0</div>
                </div>

            </div>
            </header>
        
        <main class="text-center flex-grow flex flex-col justify-center items-center">
            
            <div class="space-y-3 mb-12">
                <br/>
                <h1 id="user-name" class="text-4xl md:text-6xl font-extrabold glowing-text"></h1>
                <p id="user-team" class="text-2xl md:text-4xl font-medium opacity-90 glowing-text"></p>
                <p id="user-role" class="text-xl md:text-3xl font-light opacity-80 glowing-text italic">Waiting for scan</p>
            </div>
            
            </main>

        <footer class="flex flex-col items-center text-xs md:text-base w-full pt-8">
            
            <div class="w-full text-center glowing-text mb-2">
                <p id="scan-message" class="text-lg md:text-3xl font-bold text-yellow-300">Please scan your badge</p>
            </div>

            <div id="statusContainer" class="w-full max-w-lg text-center rounded-lg bg-gray-900 bg-opacity-70 shadow-xl border border-gray-700">
                <p id="statusMessage" class="text-base md:text-lg font-bold text-white">Ready to scan...</p>
            </div>
            
        </footer>


    </div>
    <!-- NFC input moved to controls-container -->
</div>

<script>
    // 1. Data Definition (Placeholder - Must be defined for updateUI to work)
    const DATA = {
        scannedCount: 0,
        expectedCount: 100, // Total expected for calculations
        userName: "Welcome",
        teamName: "Event Check-In System",
        role: ""
    };
    
    // 2. DOM Elements
    const elements = {
        // UI Elements
        scanCount: document.getElementById('scanned-count'),
        scanMessage: document.getElementById('scan-message'),
        currentTime: document.getElementById('current-time'),
        currentDate: document.getElementById('current-date'),
        userName: document.getElementById('user-name'),
        userTeam: document.getElementById('user-team'),
        userRole: document.getElementById('user-role'),
        userIdInput: document.getElementById('userIdInput'), // Added manual test input

        // NFC/Scan Elements
        nfcInput: document.getElementById('nfcInput'),
        statusMessage: document.getElementById('statusMessage'),
        statusContainer: document.getElementById('statusContainer')
    };
    
    // ** UPDATED URL: Points to the new PHP script on the local XAMPP server **
    const API_BASE_URL = '/api.php'; // <--- ASSUMES folder 'nfc_app' in htdocs

    // --- Utility Functions ---

    function updateTime() {
        if (!elements.currentTime) return; 
        const now = new Date();
        
        // Update time
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        elements.currentTime.textContent = now.toLocaleTimeString('en-US', timeOptions);
        
        // Update date
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateElement = document.getElementById('current-date');
        if (dateElement) {
            dateElement.textContent = now.toLocaleDateString('en-US', dateOptions);
        }
    }

    function updateUI(statusName = DATA.userName, statusTeam = DATA.teamName, statusRole = DATA.role, newCount = DATA.scannedCount) {
        DATA.userName = statusName;
        DATA.teamName = statusTeam;
        DATA.role = statusRole;
        DATA.scannedCount = newCount;
        
        elements.userName.textContent = DATA.userName;
        elements.userTeam.textContent = DATA.teamName;
        elements.userRole.textContent = DATA.role;

        const left = DATA.expectedCount - DATA.scannedCount;
        
        elements.scanCount.textContent = DATA.scannedCount;
        
        // Update message status
        if (left <= 0) {
            elements.scanMessage.textContent = "All registrations complete! Thank you.";
            elements.scanMessage.classList.replace('text-yellow-300', 'text-green-400');
        } else {
            elements.scanMessage.textContent = "Please scan your badge";
            elements.scanMessage.classList.replace('text-green-400', 'text-yellow-300');
        }
    }
    
    /**
     * Clears all state classes from the input field.
     */
    function resetInputClasses() {
        elements.nfcInput.classList.remove('processing', 'success', 'error', 'input-active');
    }

    /**
     * Resets the UI back to the ready state.
     */
    function resetState() {
        resetInputClasses();
        elements.nfcInput.classList.add('input-active');
        elements.statusContainer.classList.remove('processing', 'success', 'error');
        elements.nfcInput.disabled = false;
        
        // Re-focus the hidden input for the next scan
        try {
            elements.nfcInput.focus();
            if (typeof elements.nfcInput.select === 'function') elements.nfcInput.select();
        } catch (e) { /* ignore */ }
    }
    
    /**
     * Standardized failure handler for server errors or lookup failures.
     */
    function handleFailure(step, error, delay = 250) {
        console.error(`Execution Error during ${step}:`, error);
        resetInputClasses();
        elements.nfcInput.classList.add('error');
        elements.statusContainer.classList.remove('processing', 'success');
        elements.statusContainer.classList.add('error');
        // Adjusted text colors to be brighter against a dark background
        elements.statusMessage.innerHTML = `<span class="text-red-300 font-bold">❌ CRITICAL ${step} ERROR:</span><br>
                                            <span class="text-red-200">${error.message || error.toString()}</span>`;
        setTimeout(resetState, delay);
    }
    
    // --- NEW: Total Count Logic ---

    async function fetchTerminalCount() {
        const terminalId = elements.userIdInput.value;
        if (!terminalId) return; // Do nothing if no terminal is selected

        try {
            const payload = { terminal_id: terminalId };
            
            let response = await fetch(`${API_BASE_URL}?action=get_count`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
                const newCount = result.total_count;
                // Only update the count, preserve other UI data
                if (DATA.scannedCount !== newCount) {
                     updateUI(DATA.userName, DATA.teamName, DATA.role, newCount);
                }
            } else {
                console.warn(`Failed to fetch count for terminal ${terminalId}: ${result.message || response.statusText}`);
            }

        } catch (error) {
            console.error("Count fetch failed:", error);
        }
    }

    // --- Main Scan Logic ---

    async function handleScan(value) {
        // Create payload with both NFC value and terminal ID
        const payload = {
            nfc_id: value,
            terminal_id: elements.userIdInput.value
        };

        // Reset and show processing state
        resetInputClasses();
        elements.nfcInput.classList.add('processing');
        elements.nfcInput.disabled = true;
        elements.statusMessage.innerHTML = '<span class="text-blue-300">Step 1/2: Logging ID to backend...</span>'; 
        elements.statusContainer.classList.remove('error', 'success');
        elements.statusContainer.classList.add('processing');

        try {
            // First call - Logging
            let logResponse = await fetch(`${API_BASE_URL}?action=log`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!logResponse.ok) {
                throw new Error(`Logging failed: HTTP ${logResponse.status}`);
            }
            const logResult = await logResponse.json();
            
            if (logResult.status !== 'success') {
                 throw new Error(`Logging failed: ${logResult.message}`);
            }

            elements.statusMessage.innerHTML = `<span class="text-green-300">✅ Logging Successful.</span><br>
                                <span class="text-blue-300">Step 2/2: Searching lookup data...</span>`; 

            // Second call - Lookup
            let lookupResponse = await fetch(`${API_BASE_URL}?action=lookup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const lookupResult = await lookupResponse.json();
            
            // Fetch the latest count immediately after a successful log/lookup
            await fetchTerminalCount(); 

            if (lookupResponse.ok && lookupResult.status === 'success') {
                const result = lookupResult.row;
                
                resetInputClasses();
                elements.nfcInput.classList.add('success');
                elements.statusContainer.classList.remove('processing');
                elements.statusContainer.classList.add('success');
                
                elements.statusMessage.innerHTML = `
                    <span class="text-green-400 font-bold">✅ Check-in Success!</span><br>
                    <span class="text-white">${result[0]}</span>
                `;
                
                // updateUI now relies on fetchTerminalCount for the count, but updates other details
                updateUI(result[1], result[2], result[3], DATA.scannedCount); 
                
                setTimeout(resetState, 250); // Delay reset (quick)
                
            } else {
                const errorMessage = lookupResult.message || `Lookup failed: ${lookupResponse.statusText}`;
                // Keep the UI state updated even if lookup fails (for visual confirmation)
                updateUI("User not found", "", `Logged ID: ${value}`, DATA.scannedCount); 
                handleFailure('Lookup', { message: errorMessage }, 250);
            }
        
        } catch (error) {
            // Ensure the count is up to date even if the API interaction fails
            await fetchTerminalCount(); 
            handleFailure('API Interaction', error);
        }
    }

    // --- Initialization and Event Listeners ---

    // 5. Initialization: Wait for the page to load
    window.onload = () => {
        
        // Initial setup for UI (using default DATA)
        updateUI();

        // Call time function immediately
        updateTime(); 
        
        // Update time every second
        setInterval(updateTime, 1000);

        // --- NEW: Start count fetching interval ---
        // Fetch count immediately on load/selection change, then every 5 seconds.
        const countInterval = setInterval(fetchTerminalCount, 5000); 

        // Ensure the hidden NFC input is focused.
        if (elements.nfcInput) {
            setTimeout(resetState, 50); // Use resetState to ensure focus/select is called
        }
        
        // Event Listener: Captures Enter key to initiate scan
        elements.nfcInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                let value = elements.nfcInput.value.trim();
                let terminalId = elements.userIdInput.value;

                if (!terminalId) {
                    handleFailure('Validation', { message: 'Please select a terminal first' }, 250);
                    return;
                }

                if (value && !elements.nfcInput.disabled) {
                    elements.nfcInput.value = ''; // Clear immediately
                    handleScan(value);
                }
            }
        });

        // Event Listener: Handle terminal selection change
        elements.userIdInput.addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            DATA.teamName = selectedValue; // Update the teamName to the selected value
            updateUI(); // Refresh the UI with the new teamName
            fetchTerminalCount(); // Fetch count immediately when terminal changes
        });

    };
</script>

</body>
</html>